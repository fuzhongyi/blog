---
title: ä»å¤šçº¿ç¨‹åˆ° Event Loop
date: 2020-03-21 13:45:07
tags: javascript
categories: æŠ€æœ¯æ°´æ³¢æ–‡
---

![](/event-loop/header-img.webp)

åœ¨æˆ‘ä»¬çš„è®¤çŸ¥ä¸­ï¼Œjavascript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†å®ƒåˆæ˜¯å¦‚ä½•å®Œæˆè¯¸å¦‚å¼‚æ­¥è¯·æ±‚è¿™ç§å¤šçº¿ç¨‹æ“ä½œçš„å‘¢ï¼Ÿ
æˆ‘ä»¬å…ˆä»è¿›ç¨‹ã€çº¿ç¨‹çš„è§’åº¦æ¥äº†è§£è¿™ä¸ªé—®é¢˜ã€‚

## è¿›ç¨‹ä¸çº¿ç¨‹

+ `è¿›ç¨‹` æ˜¯ `cpu` èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼ˆæ˜¯èƒ½æ‹¥æœ‰èµ„æºå’Œç‹¬ç«‹è¿è¡Œçš„æœ€å°å•ä½ï¼‰
+ `çº¿ç¨‹` æ˜¯ `cpu` è°ƒåº¦çš„æœ€å°å•ä½ï¼ˆçº¿ç¨‹æ˜¯å»ºç«‹åœ¨è¿›ç¨‹çš„åŸºç¡€ä¸Šçš„ä¸€æ¬¡ç¨‹åºè¿è¡Œå•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼‰
+ ä¸åŒè¿›ç¨‹ä¹‹é—´ä¹Ÿå¯ä»¥é€šä¿¡ï¼Œä»£ä»·è¾ƒå¤§

ç®€å•ç†è§£ï¼Œæˆ‘ä»¬æŠŠ `cpu` æ¯”ä½œå·¥å‚ï¼Œå·¥å‚æœ‰å¤šä¸ªè½¦é—´ï¼Œä½†å·¥å‚çš„ç”µåŠ›æœ‰é™ï¼Œæ¯æ¬¡åªèƒ½ä¾›ç»™ä¸€ä¸ªè½¦é—´ä½¿ç”¨ï¼ˆå•ä¸ª `cpu` ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚`è¿›ç¨‹` å°±å¥½æ¯”å·¥å‚çš„è½¦é—´ï¼Œå®ƒä»£è¡¨ `cpu` æ‰€èƒ½å¤„ç†çš„å•ä¸ªä»»åŠ¡, è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä»»ä¸€æ—¶åˆ»ï¼Œ`cpu` æ€»æ˜¯è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹å¤„äºéè¿è¡ŒçŠ¶æ€ã€‚ `cpu` ä½¿ç”¨æ—¶é—´ç‰‡è½®è½¬è¿›åº¦ç®—æ³•æ¥å®ç°åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ã€‚`çº¿ç¨‹` å°±å¥½æ¯”è½¦é—´é‡Œçš„å·¥äººï¼Œä¸€ä¸ªè½¦é—´é‡Œï¼Œå¯ä»¥æœ‰å¾ˆå¤šå·¥äººï¼Œå…±äº«è½¦é—´æ‰€æœ‰çš„èµ„æºï¼Œä»–ä»¬ååŒå®Œæˆä¸€ä¸ªä»»åŠ¡ã€‚

ä¸€ä¸ª `è¿›ç¨‹` å¯ä»¥åŒ…æ‹¬å¤šä¸ª `çº¿ç¨‹`ï¼Œå¤šä¸ª `çº¿ç¨‹` å…±äº« `è¿›ç¨‹` èµ„æºã€‚

## æµè§ˆå™¨åŒ…å«äº†å“ªäº›è¿›ç¨‹

+ ä¸»è¿›ç¨‹
  + åè°ƒæ§åˆ¶å…¶ä»–å­è¿›ç¨‹ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰
  + æµè§ˆå™¨ç•Œé¢æ˜¾ç¤ºï¼Œç”¨æˆ·äº¤äº’ï¼Œå‰è¿›ã€åé€€ã€æ”¶è—
  + å°†æ¸²æŸ“è¿›ç¨‹å¾—åˆ°çš„å†…å­˜ä¸­çš„ Bitmapï¼Œç»˜åˆ¶åˆ°ç”¨æˆ·ç•Œé¢ä¸Š
  + å¤„ç†ä¸å¯è§æ“ä½œï¼Œç½‘ç»œè¯·æ±‚ï¼Œæ–‡ä»¶è®¿é—®ç­‰

+ ç¬¬ä¸‰æ–¹æ’ä»¶è¿›ç¨‹

  + æ¯ç§ç±»å‹çš„æ’ä»¶å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œä»…å½“ä½¿ç”¨è¯¥æ’ä»¶æ—¶æ‰åˆ›å»º
+ GPUè¿›ç¨‹
  + ç”¨äº3Dç»˜åˆ¶ç­‰

+ æ¸²æŸ“è¿›ç¨‹ï¼Œå°±æ˜¯æˆ‘ä»¬è¯´çš„æµè§ˆå™¨å†…æ ¸
  + è´Ÿè´£é¡µé¢æ¸²æŸ“ï¼Œè„šæœ¬æ‰§è¡Œï¼Œäº‹ä»¶å¤„ç†ç­‰
  + æ¯ä¸ªtabé¡µä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹

äº†è§£åˆ°æµè§ˆå™¨æ‰€åŒ…å«çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¸²æŸ“è¿›ç¨‹æ˜¯å‰ç«¯æ“ä½œæœ€é‡è¦çš„ä¸€ç¯ã€‚

## æ¸²æŸ“è¿›ç¨‹

æˆ‘ä»¬çŸ¥é“ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¿›ç¨‹åŒ…å«äº†å¤šæ¡çº¿ç¨‹ã€‚

å¯¹äº `æ¸²æŸ“è¿›ç¨‹` è€Œè¨€ï¼Œå®ƒä¹Ÿæ˜¯å¤šçº¿ç¨‹çš„ï¼ŒåŒ…å«ï¼š

+ GUI æ¸²æŸ“çº¿ç¨‹
  + è´Ÿè´£æ¸²æŸ“é¡µé¢ï¼Œå¸ƒå±€å’Œç»˜åˆ¶
  + é¡µé¢éœ€è¦é‡ç»˜å’Œå›æµæ—¶ï¼Œè¯¥çº¿ç¨‹å°±ä¼šæ‰§è¡Œ
  + ä¸ JS å¼•æ“çº¿ç¨‹äº’æ–¥ï¼Œé˜²æ­¢æ¸²æŸ“ç»“æœä¸å¯é¢„æœŸ

+ JS å¼•æ“çº¿ç¨‹
  + è´Ÿè´£å¤„ç†è§£æå’Œæ‰§è¡Œ javascript è„šæœ¬ç¨‹åº
  + åªæœ‰ä¸€ä¸ª JS å¼•æ“çº¿ç¨‹ï¼ˆå•çº¿ç¨‹ï¼‰
  + ä¸ GUI æ¸²æŸ“çº¿ç¨‹äº’æ–¥ï¼Œé˜²æ­¢æ¸²æŸ“ç»“æœä¸å¯é¢„æœŸ

+ äº‹ä»¶è§¦å‘çº¿ç¨‹
  + ç”¨æ¥æ§åˆ¶äº‹ä»¶å¾ªç¯ï¼ˆé¼ æ ‡ç‚¹å‡»ã€setTimeoutã€ajax ç­‰ï¼‰
  + å½“äº‹ä»¶æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼Œå°†äº‹ä»¶æ”¾å…¥åˆ°JSå¼•æ“æ‰€åœ¨çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­

+ å®šæ—¶è§¦å‘å™¨çº¿ç¨‹
  + setInterval ä¸ setTimeout æ‰€åœ¨çš„çº¿ç¨‹
  + å®šæ—¶ä»»åŠ¡å¹¶ä¸æ˜¯ç”± JS å¼•æ“è®¡æ—¶çš„ï¼Œæ˜¯ç”±å®šæ—¶è§¦å‘çº¿ç¨‹æ¥è®¡æ—¶çš„
  + è®¡æ—¶å®Œæ¯•åï¼Œé€šçŸ¥äº‹ä»¶è§¦å‘çº¿ç¨‹

+ å¼‚æ­¥ http è¯·æ±‚çº¿ç¨‹
  + æµè§ˆå™¨æœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ç”¨äºå¤„ç† ajax è¯·æ±‚
  + å½“è¯·æ±‚å®Œæˆæ—¶ï¼Œè‹¥æœ‰å›è°ƒå‡½æ•°ï¼Œé€šçŸ¥äº‹ä»¶è§¦å‘çº¿ç¨‹

å½“æˆ‘ä»¬äº†è§£äº†æ¸²æŸ“è¿›ç¨‹åŒ…å«çš„çº¿ç¨‹åï¼Œæˆ‘ä»¬æ€è€ƒä¸ºä»€ä¹ˆ javascript æ˜¯å•çº¿ç¨‹çš„ã€‚

## ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹

å› ä¸ºå¤šçº¿ç¨‹çš„å¤æ‚æ€§ï¼Œå¤šçº¿ç¨‹æ“ä½œéœ€è¦åŠ é”ï¼Œç¼–ç çš„å¤æ‚æ€§ä¼šå¢é«˜ã€‚å¦‚æœåŒæ—¶æ“ä½œ DOM ï¼Œåœ¨å¤šçº¿ç¨‹ä¸åŠ é”çš„æƒ…å†µä¸‹ï¼Œæœ€ç»ˆä¼šå¯¼è‡´ DOM æ¸²æŸ“çš„ç»“æœä¸å¯é¢„æœŸã€‚

## ä» event loop çœ‹ JS è¿è¡Œæœºåˆ¶

åˆ°äº†è¿™é‡Œï¼Œç»ˆäºè¦è¿›å…¥æˆ‘ä»¬çš„ä¸»é¢˜ï¼Œä»€ä¹ˆæ˜¯ `event loop`ã€‚

å…ˆç†è§£ä¸€äº›æ¦‚å¿µï¼š

+ JS åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡
+ åŒæ­¥ä»»åŠ¡éƒ½åœ¨ JS å¼•æ“çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆ
+ äº‹ä»¶è§¦å‘çº¿ç¨‹ç®¡ç†ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå¼‚æ­¥ä»»åŠ¡è§¦å‘æ¡ä»¶è¾¾æˆï¼Œå°†å›è°ƒäº‹ä»¶æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­
+ æ‰§è¡Œæ ˆä¸­æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ JS å¼•æ“çº¿ç¨‹ç©ºé—²ï¼Œç³»ç»Ÿä¼šè¯»å–ä»»åŠ¡é˜Ÿåˆ—ï¼Œå°†å¯è¿è¡Œçš„å¼‚æ­¥ä»»åŠ¡å›è°ƒäº‹ä»¶æ·»åŠ åˆ°æ‰§è¡Œæ ˆä¸­ï¼Œå¼€å§‹æ‰§è¡Œ

![](/event-loop/5-1.png)

åœ¨å‰ç«¯å¼€å‘ä¸­æˆ‘ä»¬ä¼šé€šè¿‡ `setTimeout`ã€`setInterval` æ¥æŒ‡å®šå®šæ—¶ä»»åŠ¡ï¼Œé€šè¿‡ `xhr`ã€`fetch` å‘é€ç½‘ç»œè¯·æ±‚ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œä¸ç®¡æ˜¯è¿™äº›å®šæ—¶ä»»åŠ¡æˆ–è€…ç½‘ç»œè¯·æ±‚ï¼Œè¿™äº›ä»£ç åœ¨æ‰§è¡Œï¼Œæœ¬èº«æ˜¯åŒæ­¥ä»»åŠ¡çš„ï¼Œè€Œå…¶ä¸­çš„å›è°ƒå‡½æ•°æ‰æ˜¯å¼‚æ­¥ä»»åŠ¡ã€‚

å½“ä»£ç æ‰§è¡Œåˆ° `setTimeout`ã€`setInterval` æ—¶ï¼Œå®é™…ä¸Šæ˜¯ `JSå¼•æ“çº¿ç¨‹` é€šçŸ¥ `å®šæ—¶è§¦å‘å™¨çº¿ç¨‹`ï¼Œåœ¨é—´éš”æŒ‡å®šæ—¶é—´åï¼Œä¼šè§¦å‘ä¸€ä¸ªå›è°ƒäº‹ä»¶ï¼Œ è€Œ `å®šæ—¶è§¦å‘å™¨çº¿ç¨‹` åœ¨æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œä¼šåœ¨ç­‰å¾…çš„æ—¶é—´åï¼Œå°†å›è°ƒäº‹ä»¶æ”¾å…¥åˆ°ç”± `äº‹ä»¶è§¦å‘çº¿ç¨‹` æ‰€ç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚

å½“ä»£ç æ‰§è¡Œåˆ° `xhr`ã€`fetch` æ—¶ï¼Œå®é™…ä¸Šæ˜¯ `JSå¼•æ“çº¿ç¨‹` é€šçŸ¥ `å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹`ï¼Œå‘é€ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œå¹¶åˆ¶å®šè¯·æ±‚å®Œæˆåçš„å›è°ƒäº‹ä»¶ï¼Œ è€Œ `å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹` åœ¨æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œä¼šåœ¨è¯·æ±‚æˆåŠŸåï¼Œå°†å›è°ƒäº‹ä»¶æ”¾å…¥åˆ°ç”±`äº‹ä»¶è§¦å‘çº¿ç¨‹` æ‰€ç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚

å½“æˆ‘ä»¬çš„åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œï¼Œ`JSå¼•æ“çº¿ç¨‹` ä¼šè¯¢é—® `äº‹ä»¶è§¦å‘çº¿ç¨‹`ï¼Œåœ¨äº‹ä»¶é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœæœ‰å°±ä¼šåŠ å…¥åˆ°æ‰§è¡Œæ ˆä¸­äº¤ç»™ `JSå¼•æ“çº¿ç¨‹` æ‰§è¡Œã€‚

ç”¨ä¸€å¼ å›¾æ¥è§£é‡Šï¼š

![](/event-loop/5-2.webp)

æ€»ç»“ï¼š

1. JS å¼•æ“çº¿ç¨‹æ‰§è¡Œæ‰§è¡Œæ ˆä¸­çš„äº‹ä»¶
2. æ‰§è¡Œæ ˆä¸­çš„äº‹ä»¶æ‰§è¡Œå®Œæ¯•ï¼Œå°±å¼€å§‹è¯»å–äº‹ä»¶é˜Ÿåˆ—ä¸­çš„äº‹ä»¶
3. äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å›è°ƒäº‹ä»¶åŠ å…¥åˆ°æ‰§è¡Œæ ˆä¾æ¬¡æ‰§è¡Œ

`2`,`3` é‡å¤å¾ªç¯

## å®ä»»åŠ¡ã€å¾®ä»»åŠ¡

å½“æˆ‘ä»¬åŸºæœ¬äº†è§£äº†ä»€ä¹ˆæ˜¯æ‰§è¡Œæ ˆï¼Œä»€ä¹ˆæ˜¯äº‹ä»¶é˜Ÿåˆ—ä¹‹åï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹äº‹ä»¶å¾ªç¯ä¸­ `å®ä»»åŠ¡`ã€`å¾®ä»»åŠ¡`ã€‚

### å®ä»»åŠ¡

æˆ‘ä»¬å¯ä»¥å°†æ¯æ¬¡æ‰§è¡Œæ ˆæ‰§è¡Œçš„ä»£ç å½“åšæ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ¯æ¬¡ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªäº‹ä»¶å›è°ƒå¹¶æ”¾åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼‰ï¼Œ
æ¯ä¸€ä¸ªå®ä»»åŠ¡ä¼šä»å¤´åˆ°å°¾æ‰§è¡Œå®Œæ¯•ï¼Œä¸ä¼šæ‰§è¡Œå…¶ä»–ã€‚
æˆ‘ä»¬å‰æ–‡æåˆ°è¿‡ `JSå¼•æ“çº¿ç¨‹` å’Œ `GUIæ¸²æŸ“çº¿ç¨‹` æ˜¯äº’æ–¥çš„å…³ç³»ï¼Œæµè§ˆå™¨ä¸ºäº†èƒ½å¤Ÿä½¿å®ä»»åŠ¡å’Œ `DOM` ä»»åŠ¡æœ‰åºçš„è¿›è¡Œï¼Œä¼šåœ¨ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œç»“æœåï¼Œåœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå‰ï¼Œ`GUI æ¸²æŸ“çº¿ç¨‹` å¼€å§‹å·¥ä½œï¼Œå¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“ã€‚

```javascript
// å®ä»»åŠ¡-->æ¸²æŸ“-->å®ä»»åŠ¡-->æ¸²æŸ“-->ï¼ï¼ï¼
```

`scriptï¼ˆä¸»ä»£ç å—ï¼‰`ï¼Œ`setTimeout`ï¼Œ`setInterval`ã€`I/O(ajax)`,`setImmedidate(node)`ï¼Œéƒ½å±äºå®ä»»åŠ¡ã€‚

ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š

```javascript
document.body.style = 'background:black';
document.body.style = 'background:red';
document.body.style = 'background:blue';
document.body.style = 'background:grey';
```

æˆ‘ä»¬å°†è¿™æ®µä»£ç æ”¾åˆ°æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœï¼š

![](/event-loop/6-1.gif)

æˆ‘ä»¬çœ‹åˆ°ï¼Œé¡µé¢èƒŒæ™¯ä¼šåœ¨ç¬é—´å˜æˆç°è‰²ã€‚è¿™æ˜¯å› ä¸ºä»¥ä¸Šä»£ç å±äºåŒä¸€æ¬¡å®ä»»åŠ¡ï¼Œæ‰€ä»¥å…¨éƒ¨æ‰§è¡Œå®Œæ‰è§¦å‘é¡µé¢æ¸²æŸ“ï¼Œæ¸²æŸ“æ—¶`GUI æ¸²æŸ“çº¿ç¨‹`ä¼šå°†æ‰€æœ‰ UI æ”¹åŠ¨åˆå¹¶ä¼˜åŒ–ï¼Œæ‰€ä»¥åœ¨è§†è§‰æ•ˆæœä¸Šï¼Œåªä¼šçœ‹åˆ°é¡µé¢å˜æˆç°è‰²ã€‚

å†æ¥ä¸ªä¾‹å­ğŸŒ°ğŸŒ°ï¼š

```javascript
document.body.style = 'background:blue';
setTimeout(function() {
    document.body.style = 'background:black'
}, 0);
```

æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹ä¸‹æ•ˆæœï¼š

![](/event-loop/6-2.gif)

æˆ‘ä»¬çœ‹åˆ°ï¼Œé¡µé¢å…ˆæ˜¾ç¤ºæˆè“è‰²èƒŒæ™¯ï¼Œç„¶ååˆå˜æˆäº†é»‘è‰²èƒŒæ™¯ï¼Œè¿™æ˜¯å› ä¸ºä»¥ä¸Šä»£ç å±äºä¸¤æ¬¡ `å®ä»»åŠ¡`ï¼Œç¬¬ä¸€æ¬¡ `å®ä»»åŠ¡` æ‰§è¡Œçš„ä»£ç æ˜¯å°†èƒŒæ™¯å˜æˆè“è‰²ï¼Œç„¶åè§¦å‘æ¸²æŸ“ï¼Œå°†é¡µé¢å˜æˆè“è‰²ï¼Œå†è§¦å‘ç¬¬äºŒæ¬¡ `å®ä»»åŠ¡` å°†èƒŒæ™¯å˜æˆé»‘è‰²ã€‚

### å¾®ä»»åŠ¡

æˆ‘ä»¬å·²ç»çŸ¥é“ `å®ä»»åŠ¡` ç»“æŸåï¼Œä¼šæ‰§è¡Œæ¸²æŸ“ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ª `å®ä»»åŠ¡`ï¼Œ è€Œ `å¾®ä»»åŠ¡` å¯ä»¥ç†è§£æˆåœ¨å½“å‰ `å®ä»»åŠ¡` æ‰§è¡Œåç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ `å®ä»»åŠ¡` æ‰§è¡Œå®Œï¼Œä¼šåœ¨æ¸²æŸ“å‰ï¼Œå°†æ‰§è¡ŒæœŸé—´æ‰€äº§ç”Ÿçš„æ‰€æœ‰ `å¾®ä»»åŠ¡` éƒ½æ‰§è¡Œå®Œã€‚

```javascript
// å®ä»»åŠ¡-->å¾®ä»»åŠ¡-->æ¸²æŸ“-->å®ä»»åŠ¡-->å¾®ä»»åŠ¡-->æ¸²æŸ“-->ï¼ï¼ï¼
```

`process.nextTick(node)`ï¼Œ`Promise`ï¼Œ`MutationObserver` å±äºå¾®ä»»åŠ¡ã€‚

`process.nextTick` æ˜¯æœ‰ä¸€ä¸ªæ’é˜Ÿæ“ä½œçš„ï¼Œå°±æ˜¯è¯´ä»–è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—æ—¶ï¼Œä¼šæ’åˆ°é™¤äº† `process.nextTick` å…¶ä»–çš„å¾®ä»»åŠ¡å‰é¢ã€‚

ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š

```javascript
document.body.style = 'background:blue'
console.log(1);
Promise.resolve().then(()=>{
    console.log(2);
    document.body.style = 'background:black'
});
console.log(3);
```

æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹ä¸‹æ•ˆæœï¼š

![](/event-loop/6-3.gif)

æ§åˆ¶å°è¾“å‡º 1 3 2 , æ˜¯å› ä¸º `promise` å¯¹è±¡çš„ `then` æ–¹æ³•çš„å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥ 2 æœ€åè¾“å‡ºé¡µé¢çš„èƒŒæ™¯è‰²ç›´æ¥å˜æˆé»‘è‰²ï¼Œæ²¡æœ‰ç»è¿‡è“è‰²çš„é˜¶æ®µï¼Œæ˜¯å› ä¸ºï¼Œæˆ‘ä»¬åœ¨å®ä»»åŠ¡ä¸­å°†èƒŒæ™¯è®¾ç½®ä¸ºè“è‰²ï¼Œä½†åœ¨è¿›è¡Œæ¸²æŸ“å‰æ‰§è¡Œäº†å¾®ä»»åŠ¡ï¼Œåœ¨å¾®ä»»åŠ¡ä¸­å°†èƒŒæ™¯å˜æˆäº†é»‘è‰²ï¼Œç„¶åæ‰æ‰§è¡Œçš„æ¸²æŸ“ã€‚

å†æ¯”å¦‚è¯´ï¼š

```javascript
setTimeout(() => {
    console.log(1);
    Promise.resolve(3).then(data => console.log(data));
}, 0);
setTimeout(() => {
    console.log(2)
}, 0);
// 1 3 2
```

ä¸Šé¢ä»£ç å…±åŒ…å«ä¸¤ä¸ª `setTimeout`ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤ä¸»ä»£ç å—å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ª `å®ä»»åŠ¡`ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª `å®ä»»åŠ¡` æ‰§è¡Œä¸­ï¼Œè¾“å‡º 1ï¼Œå¹¶ä¸”åˆ›å»ºäº† `å¾®ä»»åŠ¡é˜Ÿåˆ—`ï¼Œæ‰€ä»¥åœ¨ä¸‹ä¸€ä¸ª `å®ä»»åŠ¡é˜Ÿåˆ—` æ‰§è¡Œå‰ï¼Œå…ˆæ‰§è¡Œ `å¾®ä»»åŠ¡`ï¼Œåœ¨ `å¾®ä»»åŠ¡` æ‰§è¡Œä¸­ï¼Œè¾“å‡º 3 ï¼Œ`å¾®ä»»åŠ¡` æ‰§è¡Œåï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡ `å®ä»»åŠ¡`ï¼Œæ‰§è¡Œä¸­è¾“å‡º 2ã€‚

## æ€»ç»“

+ æ‰§è¡Œä¸€ä¸ª`å®ä»»åŠ¡` ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä» `äº‹ä»¶é˜Ÿåˆ—` ä¸­è·å–ï¼‰
+ æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ° `å¾®ä»»åŠ¡`ï¼Œå°±å°†å®ƒæ·»åŠ åˆ° `å¾®ä»»åŠ¡é˜Ÿåˆ—`ä¸­
+ å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰ `å¾®ä»»åŠ¡é˜Ÿåˆ—` ä¸­çš„æ‰€æœ‰ `å¾®ä»»åŠ¡` ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
+ å½“å‰ `å®ä»»åŠ¡` æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶å `GUI æ¸²æŸ“çº¿ç¨‹` æ¥ç®¡æ¸²æŸ“
+ æ¸²æŸ“å®Œæ¯•åï¼Œ`JSå¼•æ“çº¿ç¨‹` ç»§ç»­æ¥ç®¡ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ª `å®ä»»åŠ¡`ï¼ˆä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰

![](/event-loop/7-1.webp)

## é¢˜å¤–è¯

``` javascript
setTimeout(()=>console.log(3), 2);
setTimeout(()=>console.log(2), 1);
setTimeout(()=>console.log(1), 0);
```

æ²¡æœ‰æ·±å…¥æ¥è§¦è¿‡ `timer` çš„åŒå­¦å¦‚æœç›´æ¥ä»ä»£ç ä¸­çš„å»¶æ—¶è®¾ç½®æ¥çœ‹ï¼Œä¼šå›ç­”ï¼š`1ã€2ã€3`ã€‚

è€Œå¦ä¸€äº›æœ‰ä¸€å®šç»éªŒçš„åŒå­¦å¯èƒ½ä¼šå›ç­”ï¼š`3ã€2ã€1`ã€‚å› ä¸º [MDN çš„ setTimeout](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/setTimeout) æ–‡æ¡£ä¸­æåˆ° `HTML` è§„èŒƒæœ€ä½å»¶æ—¶ä¸º **4ms**ï¼š

*(è¡¥å……è¯´æ˜ï¼šæœ€ä½å»¶æ—¶çš„è®¾ç½®æ˜¯ä¸ºäº†ç»™CPUç•™ä¸‹ä¼‘æ¯æ—¶é—´ï¼‰*

> In fact, 4ms is specified by the HTML5 spec and is consistent across browsers released in 2010 and onward. Prior to (Firefox 5.0 / Thunderbird 5.0 / SeaMonkey 2.2), the minimum timeout value for nested timeouts was 10 ms.

è€ŒçœŸæ­£ç—›è¿‡çš„åŒå­¦ä¼šå‘Šè¯‰ä½ ï¼Œç­”æ¡ˆæ˜¯ï¼š`1ã€0ã€2`ã€‚

æˆ‘ä»¬å‘ç° 0ms å’Œ 1ms çš„å»¶æ—¶æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡èµ„æ–™æˆ‘ä»¬å‘ç°ï¼š

### åœ¨ chrome ä¸­

```javascript
// https://chromium.googlesource.com/chromium/blink/+/master/Source/core/frame/DOMTimer.cpp#93
double intervalMilliseconds = std::max(oneMillisecond, interval * oneMillisecond);
```

è¿™é‡Œ interval å°±æ˜¯ä¼ å…¥çš„æ•°å€¼ï¼Œå¯ä»¥çœ‹å‡ºä¼ å…¥ 0 å’Œä¼ å…¥ 1 ç»“æœéƒ½æ˜¯ oneMillisecondï¼Œå³ 1msã€‚

è¿™æ ·è§£é‡Šäº†ä¸ºä½• 1ms å’Œ 0ms è¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼Œé‚£ 4ms åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼ŸæŸ¥é˜… [HTML è§„èŒƒ](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers)ï¼Œå‘ç°è™½ç„¶æœ‰ 4ms çš„é™åˆ¶ï¼Œä½†æ˜¯æ˜¯å­˜åœ¨æ¡ä»¶çš„ï¼Œè¯¦è§è§„èŒƒç¬¬ 11 ç‚¹ï¼š

> If nesting level is greater than 5, and timeout is less than 4, then set timeout to 4.

### åœ¨ node ä¸­

```javascript
// https://github.com/nodejs/node/blob/v8.9.4/lib/timers.js#L456
if (!(after >= 1 && after <= TIMEOUT_MAX))
  after = 1; // schedule on next tick, follows browser behavior
```

ä»£ç ä¸­çš„æ³¨é‡Šç›´æ¥è¯´æ˜äº†ï¼Œè®¾ç½®æœ€ä½ 1ms çš„è¡Œä¸ºæ˜¯ä¸ºäº†å‘æµè§ˆå™¨è¡Œä¸ºçœ‹é½ã€‚
